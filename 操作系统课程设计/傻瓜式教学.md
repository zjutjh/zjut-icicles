# 《怎么办》

- 请使用主流 Linux 系统，**不要使用 ArchLinux** / openEuler，后者生成的 loader.bin 长达 128M（含有大量字符0，压缩后为8K），远超启动 Pintos 允许的314B/512B。

- 适用于最新版 Windows 10/11。
- **文档中的方括号在实际命令中不存在**。

## 关联仓库

- 关注通知，答疑群进群名额**先到先得**。按通知以初始账户登录 GitLab 网站，验证学号，并登录判题网站。不要新建账号。

## 配置 Linux

1. 在 Microsoft Store 下载一个 Linux 子系统，启动后会弹窗安装 WSL 2 组件，安装完成后重启你的 Linux。你可以随时使用下列命令更新 Linux 的一切组件，以 Ubuntu 为例：

   `sudo apt update`

2. 按提示输入你的用户名和密码，创建一个账户。

3. 安装 gcc clang gnu-binutils make git qemu xclip 工具，也应安装 perl。可以分别执行 install，使用例如 `gcc -v` 的命令检查组件是否已安装。使用管理员命令 `sudo`：

   `sudo apt install gcc clang binutils make git xclip qemu-system-i386`

4. 输入 `mkdir lab`，再使用 `cd lab` 进入 lab 目录。

   了解一些基础的 Linux 命令，详细学习可修读"Linux 系统及其应用"课程：

   `cd [路径]` 从当前目录打开文件夹路径，无参数则回到主目录，`cd ..` 回到上一级目录

   `pwd` 显示当前路径

   `ls` 列出当前目录内容

   `mkdir [文件夹]` 创建文件夹

   `rm [选项] [文件(夹)名]` 删除文件(夹)，使用 -rf 选项可删除文件夹及其所有内容，慎用

   Ctrl+C 中止命令

## 连接仓库

1. 克隆源代码，直接移植含有 hw-shell 和 pintos 两个文件夹，可在判题机上提交的版本。请以当年 ZJUT OSD Course 账号上的项目为准，建议如下复制使用 Code - Clone with SSH 的链接：

   `git clone git@gitlab.etao.net:zjutosd/fa23.git`

2. 参照 [使用 SSH keys 和极狐GitLab 通信 - GitLab - GitLab 文档中心](https://docs.gitlab.cn/docs/jh/user/ssh/index.html#generate-an-ssh-key-pair)，生成 SSH 密钥，然后按提示添加到账户中。你可以不输入密码，也可以不指定 RSA 的位数，但请将密钥视为**机密**。不需要规定到期日期。教学示例使用 RSA，请注意改掉命令中的文件名。`xclip` 会将密钥复制到 Windows 剪贴板。

   使用 `ssh -T git@gitlab.etao.net` 验证关联成功。

3. 复制仓库 SSH 地址，格式应和第1步类似，以 git 结尾，执行下述步骤：

   `git remote add origin [你的SSH地址]`

   `cd fa23`

   `git push origin master`

   刷新你的仓库，应当出现源文件。

   以后改好的代码发布到仓库上，统一使用下面三步：

   `git add .`

   `git commit -m "Finished adding basic functionality into the shell."` （引号里的消息可以自定义，用来给自己看）

   `git push origin master` 请使用 master 分支，若担心上传错误，可使用 `git push [你的SSH地址]`。

## 运行 CS162 shell 作业

- 打开目录，编译并运行第一个任务：

  `cd hw-shell`

  `make`

  `./shell`

  目前仅支持 ? - 帮助功能和 exit - 关闭功能。

  在提交判题前请**删除编译产物**，可使用 `make clean`。

- 任务书，应使用的函数参照视频：

  1. 支持 cd pwd

  2. 使用 execv() 函数调用外部的 Linux 命令，不能使用 execvp()

  3. 支持 Linux 的 `>` 存入 `<` 传递 功能

  4. 支持 Linux 的 Ctrl+C 等进程命令

  5. 支持 Linux 的 & 和 wait 切换前后台进程功能。

- 你可以安装 Visual Studio Code 编辑程序。你的文件资源管理器上应当有 Linux 目录，依照 `pwd` 给出的目录在 VSCode 中打开文件夹。

- tokenizer 的结构体似乎应在头文件中给出完整定义，否则编译可能失败。

## 正式运行 Pintos

- 在 pintos/src/utils 目录下有 Pintos 内核的脚本工具。为运行 pintos 相关命令，需要在系统路径 $PATH 中注册这一目录。

  `nano ~/.bashrc` 向下直至文件尽头，在一行中输入：

  `export PATH=/home/[用户名]/lab/fa23/pintos/src/utils:$PATH`

  Ctrl+X 关闭，选择保存。

  `source ~/.bashrc` 重启相关服务。

  这时将可以使用 `which pintos` 命令。

- 打开一个任务，例如 src/threads 目录，运行 `make` 命令并等待结束，再运行 `make check`。各个测试点应当显示 FAIL。可以提前中止检查。

- 接上述命令，在 src/threads/build/tests/threads 中可通过 errors 和 output 文件显示每个测试点的情况。可以在 src/tests/threads 中查看任务的所有测试点数据。

- **无从下手**？在 CS162 文档中了解范例修改了哪些文件（如 Threads 的 [FAQ | CS 162 Project 2](https://cs162.org/static/proj/proj-threads/docs/faq/)）。

- Project 0 是什么？它和 Project 1 共用 Userprog，测试点是 do-nothing 和 stack-align-0，用于了解如何使用 GDB 调试程序。它的参考答案是在 src/userprog/process.c:128 的汇编语句前移动堆栈指针：

  `if_.esp -= 20;`

- 启动 Pintos 可能出现 stropts.h 无法引用问题，如果 `make check` 出现 127 错误，且 utils 文件夹 `make` 报错，请在 utils 中做如下工作：

  `vi squish-unix.c` 进入 VIM 编辑器，按 i 进入输入模式。

  注释 `#include <stropts.h>` 一行。

  输入 `:wq` 退出编辑器。

  `vi squish-pty.c` 同样注释该行，然后从第245行起：

  注释 `if (isasstream(slave))` 分支语句。

  完成后应当正常编译，注意提交时清除 utils 内产生的文件。

- 若要在 Userprog 及 Filesys 的基础上编写，对 threads.c 和 threads 结构体的更改语句请在宏定义分支 `#ifdef USERPROG` `#endif` 内完成。

## 提交要求

- 参照 [基本语法 | MARKDOWN 中文](https://www.markdown.cn/docs/tutorial-basics/basic-syntax/#%E6%A6%82%E8%BF%B0) 在根目录下编写 README.md 文档**作为课程设计说明**，引用的图片**按统一要求摆放**（目前放在根目录 imgs 文件夹下）。不申优**无须制作 PPT**。

- 整个仓库**不能大于4MB**，单次修改不能大于2MB。

- 分数依据是**通过的测试点**，并非判题机显示的满分100分。目前的及格要求似乎变成了 shell 满分**并且** Threads 通过33个测试点。

- 减少重复或相近 push，确保程序在本地能够按要求运行。务必使用 **master** 而非 **main** 分支。判题机无法响应带来的惩罚时间似乎是2小时。

- 出现带 @**哈希值** 的文件夹怎么办？你在源程序文件夹里又克隆了其他来源上传的文件夹，但没有获取上述目录的权限，导致 GitLab 中出现了子模块。参考 [git出现文件夹后面跟@+数字_git 目录加数字-CSDN博客](https://blog.csdn.net/qq_23590921/article/details/108087020)，操作大致如下，未经验证：

  `cd [带@的目录]`

  `rm -r .git` （这里的步骤修改是为防止主层级 git 被删）

  `cd ..`

  `git rm -r --cached .`

  然后再次尝试 add commit push。
